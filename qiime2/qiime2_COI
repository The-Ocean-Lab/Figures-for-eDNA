Based on Wright Labs workshop 05/12/2025 and 05/13/2025

1.0 Set Up

# creating a working directory folder
# create a folder called raw_data
# move all fastq.gz / .fastq files into the raw_data folder

#### activate qiime2 ####
conda activate
conda activate qiime2-amplicon-2024.10               # open qiime2 environment (this protocol is based on version 2024.10)

1.1 Create a Mapping File

#### set and go into working directory #### 
workdir="/Users/drocean/Desktop/CO1"                 # use absolute pathname of folder
cd "$workdir"                                        # go into working directory
ls -d "$PWD/raw_data/"                               # create a raw_data folder
cd raw_data                                          # go into raw_data folder
rm -f ../ids.txt                                     # removes old id.text file if there is one

for f in *.fastq.gz; do
  name=$(echo "$f" | sed -E 's/(.*)_[Rr][12].fastq.gz/\1/')
  echo "$name" >> ../ids.txt
done                                                 # extracts the name of the file before the underscore and a R or r, 1 or 2, and .fastq.gz change to .fastq if files are gunzipped
                                                     # puts these extracted names in a file called ids.txt

cd ..                                                # goes out of raw_data and into working directory 
ls -d "$PWD/raw_data/"*.fastq.gz > paths.txt         # creates a file with all the path names for fasta.gz files
paste -d "," ids.txt paths.txt > combined.csv        # combines the id.txt and path.txt files 
awk -F "," '$2 ~ /_R1/ {print $1 "," $2 ",forward"}' combined.csv > forward.csv           
                                                     # adds and labels the forward reads to the combined file
awk -F "," '$2 ~ /_R2/ {print $1 "," $2 ",reverse"}' combined.csv > reverse.csv
                                                     # adds and labels the reverse reads to the combined file
echo "sample-id,absolute-filepath,direction" > header.csv 
                                                     # creates a csv with sampleid, filepath and direction (just columns)
cat header.csv forward.csv reverse.csv > mapping.csv # add the data from each file to the appropiate column
mkdir -p import_intermediate_files                   # makes a file in working directory called intermediate files
mv paths.txt combined.csv forward.csv reverse.csv header.csv import_intermediate_files 
                                                     # puts the listed files into the intermediate files folder

1.2 Importing Raw Reads

workdir="/Users/drocean/Desktop/18S"                 
cd "$workdir"                                        # stay in same working directory, use code if need to reset
                                                     # open all files with gunzip before next line

echo "sample-id,absolute-filepath,direction" > mapping.csv
for f in /Users/drocean/Desktop/CO1/raw_data/*_R1_001.fastq.gz; do
  r2=${f/_R1_/_R2_}
  if [[ -f "$r2" ]]; then
    sample=$(basename "$f" | sed -E 's/_L001_R1_001.fastq.gz//')
    echo "$sample,$f,forward" >> mapping.csv
    echo "$sample,$r2,reverse" >> mapping.csv
  else
    echo "Missing reverse read for $f"
  fi
done

                                                    # correctly formats the manifest file, there should be a identical sample id name with F and R, change the working directory, check to see if files are fastq.gz or fastq, check if R1_001 or R1.

qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path mapping.csv \
  --output-path paired-end-demux.qza \
  --input-format PairedEndFastqManifestPhred33

                                                    # creates a paired_end_demux.qza file which qiime can read and access

2. Quality Check

qiime demux summarize \
  --i-data paired-end-demux.qza \
  --o-visualization VIEWABLE_paired-end-demux.qzv

                                                    # access https://view.qiime2.org/ and drag file
                                                    # creates a file has sample id, # of forward seqs, & and # of reverse seqs
qiime vsearch fastq-stats \
  --i-sequences paired-end-demux.qza \
  --p-threads 1 \
  --o-visualization VIEWABLE_ee_paired-end-demux.qzv

                                                    # creates a file quality plot for the forward and reverse reads
                                                    # use this file to determine where to trim base pairs

3. Denoise Data

qiime dada2 denoise-paired \
  --i-demultiplexed-seqs paired-end-demux.qza \
  --p-trim-left-f 5 \           
  --p-trim-left-r 5 \
  --p-trunc-len-f 145 \
  --p-trunc-len-r 145 \
  --o-table table.qza \
  --o-representative-sequences rep-seqs.qza \
  --o-denoising-stats denoising-stats.qza \
  --p-n-threads 4 \
  --p-max-ee-f 2 \
  --p-max-ee-r 2

                                                    # only inputs that should be changed are p-trunc-len-f/r
                                                    # p-trim left cuts off the first couple of bases
                                                    # p-max-ee-f/r determines how much error is allowed









